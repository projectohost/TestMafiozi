<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–ì—Ä–∞ –ú–∞—Ñ—ñ—è ‚Äî {{ game_code }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='game.css') }}">
</head>
<body class="mafia-bg">

<div class="container">
  <h1>–ì—Ä–∞ –ú–∞—Ñ—ñ—è ‚Äî {{ game_code }}</h1>
  <p>–§–∞–∑–∞: <span id="phase">loading</span></p>
  <p>–í–∞—à–∞ —Ä–æ–ª—å: <b id="my-role">?</b></p>

  <h3>–ì—Ä–∞–≤—Ü—ñ</h3>
  <div id="players"></div>

  <h3>–ü–æ–¥—ñ—ó</h3>
  <div id="events"></div>

  <div id="actions"></div>

  <div id="game-result"
       style="font-size:1.2em;font-weight:bold;margin-top:15px;"></div>

  <a href="{{ url_for('dashboard') }}" class="btn">–í–∏–π—Ç–∏ —É –ª–æ–±–±—ñ</a>
</div>

<script>
const gameCode = "{{ game_code }}";
const myNickname = "{{ session['user'] }}";

let currentPhase = null;
let hasActed = false;
let gameEnded = false;
let lastEventsCount = 0;

/* ---------- render players ---------- */
function renderPlayers(players) {
  const div = document.getElementById("players");
  div.innerHTML = "";

  players.forEach(p => {
    const card = document.createElement("div");
    card.className = "card" + (!p.alive ? " dead" : "");
    card.innerText = p.nickname + (p.nickname === myNickname ? " (–í–∏)" : "");
    div.appendChild(card);

    if (p.nickname === myNickname) {
      document.getElementById("my-role").innerText = p.role;
    }
  });
}

/* ---------- render events ---------- */
function renderEvents(events) {
  if (events.length === lastEventsCount) return;
  lastEventsCount = events.length;

  const div = document.getElementById("events");
  div.innerHTML = "";
  events.forEach(e => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerText = e;
    div.appendChild(card);
  });
}

/* ---------- render actions ---------- */
function renderActions(players) {
  const div = document.getElementById("actions");
  div.innerHTML = "";

  if (gameEnded || hasActed) return;

  const me = players.find(p => p.nickname === myNickname);
  if (!me || !me.alive) return;

  if (currentPhase === "night") {
    if (["mafia","don"].includes(me.role)) {
      players.filter(p => p.alive && p.nickname !== myNickname).forEach(p => {
        const b = document.createElement("button");
        b.innerText = `–í–±–∏—Ç–∏ ${p.nickname}`;
        b.onclick = () => sendAction("kill", p.nickname);
        div.appendChild(b);
      });
    }

    if (me.role === "surgeon") {
      players.filter(p => p.alive).forEach(p => {
        const b = document.createElement("button");
        b.innerText = `–í–∏–ª—ñ–∫—É–≤–∞—Ç–∏ ${p.nickname}`;
        b.onclick = () => sendAction("heal", p.nickname);
        div.appendChild(b);
      });
    }
  }

  if (currentPhase === "day") {
    players.filter(p => p.alive && p.nickname !== myNickname).forEach(p => {
      const b = document.createElement("button");
      b.innerText = `–ì–æ–ª–æ—Å—É–≤–∞—Ç–∏ –∑–∞ ${p.nickname}`;
      b.onclick = () => sendAction("vote", p.nickname);
      div.appendChild(b);
    });
  }
}

/* ---------- send action ---------- */
function sendAction(type, target) {
  fetch(`/api/game_actions/${gameCode}`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      action_type: type,
      target: target,
      phase: currentPhase
    })
  })
  .then(r => r.json())
  .then(r => {
    if (r.status === "ok") {
      hasActed = true;
      document.getElementById("actions").innerHTML = "–î—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–∞ ‚úÖ";
    }
  });
}

/* ---------- check win ---------- */
function checkWin(players) {
  const mafia = players.filter(p => p.alive && ["mafia","don"].includes(p.role)).length;
  const civ = players.filter(p => p.alive && !["mafia","don"].includes(p.role)).length;

  if (mafia === 0) {
    gameEnded = true;
    document.getElementById("game-result").innerText = "üéâ –ú–∏—Ä–Ω—ñ –ø–µ—Ä–µ–º–æ–≥–ª–∏!";
    document.getElementById("game-result").style.color = "green";
  }
  if (mafia >= civ) {
    gameEnded = true;
    document.getElementById("game-result").innerText = "üíÄ –ú–∞—Ñ—ñ—è –ø–µ—Ä–µ–º–æ–≥–ª–∞!";
    document.getElementById("game-result").style.color = "red";
  }

  if (gameEnded) clearInterval(pollingInterval);
}

/* ---------- update game ---------- */
function updateGame() {
  fetch(`/api/game/${gameCode}`)
    .then(r => r.json())
    .then(data => {
      renderPlayers(data.players);
      checkWin(data.players);

      fetch(`/api/game_phase/${gameCode}`)
        .then(r => r.json())
        .then(p => {
          if (currentPhase !== p.phase) {
            currentPhase = p.phase;
            hasActed = false;
            document.getElementById("phase").innerText = currentPhase;
          }

          renderActions(data.players);

          fetch(`/api/game_results/${gameCode}`)
            .then(r => r.json())
            .then(r => renderEvents(r.events));
        });
    });
}

/* ---------- polling ---------- */
const pollingInterval = setInterval(updateGame, 2000);
updateGame();
</script>

</body>
</html>
